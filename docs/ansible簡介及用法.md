# Ansible å­¸ç¿’ç­†è¨˜

## ä»€éº¼æ˜¯ Ansible

Ansible æ˜¯ä¸€å€‹åŸºæ–¼ Python çš„è‡ªå‹•åŒ–å·¥å…·ï¼Œç”¨ä¾†ç®¡ç†ä¼ºæœå™¨é…ç½®ã€éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼åŠè‡ªå‹•åŒ– IT ä»»å‹™ã€‚å®ƒæ¡ç”¨ **ç„¡ä»£ç†ï¼ˆagentlessï¼‰æ¶æ§‹**ï¼Œé€é **SSH é€£ç·š** ç®¡ç†ç›®æ¨™ä¸»æ©Ÿï¼Œä½¿ç”¨ç°¡å–®æ˜“è®€çš„ YAML èªæ³•æ’°å¯« Playbookã€‚

## ğŸ“Œ ä»€éº¼æ˜¯å†ªç­‰æ€§ (Idempotency)

åœ¨ è‡ªå‹•åŒ–é…ç½®ç®¡ç† è£¡ï¼Œ**å†ªç­‰æ€§æŒ‡çš„æ˜¯ åŒä¸€å€‹æ“ä½œä¸ç®¡åŸ·è¡Œå¤šå°‘æ¬¡ï¼Œæœ€çµ‚çµæœéƒ½æœƒæ˜¯ä¸€æ¨£çš„**ã€‚

æ›å¥è©±èªªï¼š

ç¬¬ä¸€æ¬¡åŸ·è¡Œï¼š**æœƒåšå‡ºéœ€è¦çš„æ”¹è®Š**ï¼ˆä¾‹å¦‚å®‰è£å¥—ä»¶ã€ä¿®æ”¹æª”æ¡ˆï¼‰ã€‚

ç¬¬äºŒæ¬¡ã€ç¬¬ä¸‰æ¬¡å†åŸ·è¡Œï¼šå¦‚æœç³»çµ±å·²ç¶“ç¬¦åˆéœ€æ±‚ï¼Œå°±ä¸æœƒ**å†é‡è¤‡æ”¹è®Š**ã€‚ 

èˆ‰ä¾‹ï¼š
```yaml
- name: å®‰è£ httpd
  yum:
    name: httpd
    state: present
```  
  
å¦‚æœç³»çµ± **é‚„æ²’è£ httpd â†’ Ansible å¹«ä½ å®‰è£ã€‚**

å¦‚æœç³»çµ± **å·²ç¶“æœ‰ httpd â†’ ä¸æœƒé‡è¤‡å®‰è£ã€‚**

é€™å°±æ˜¯**å†ªç­‰æ€§ï¼Œé¿å…ã€Œç„¡è¬‚çš„å‹•ä½œã€**ã€‚

### åè©èˆ‡ç”Ÿæ´»æ¯”å–»

| åè© | ç”Ÿæ´»æ¯”å–» |
|------|-----------|
| Task | åšä¸€ä»¶äº‹ â†’ æ¯”å¦‚ç…®ä¸€æ¯å’–å•¡ |
| Play | ä¸€çµ„äººåšä¸€çµ„ä»»å‹™ â†’ æ¯”å¦‚ã€Œåª½åª½ç…®å’–å•¡ã€å¼Ÿå¼Ÿæ‹¿é¤…ä¹¾ã€ |
| Playbook | æ•´æœ¬æ´»å‹•æ‰‹å†Š â†’ ã€Œæ—©æ™¨èšæœƒæµç¨‹ï¼Œå¾ç…®å’–å•¡åˆ°æ“ºæ¡Œå­ã€ |
| Variable | å¯æ›¿æ›çš„è³‡è¨Š â†’ ã€Œå’–å•¡å£å‘³ã€å¯ä»¥è®ŠåŒ– |
| Role | æ¨¡çµ„åŒ–å–®å…ƒ â†’ ã€Œç…®å’–å•¡çš„æµç¨‹ã€å¯ä»¥é‡è¤‡ç”¨åœ¨ä¸åŒå ´åˆ |

---

## Inventory èˆ‡ Playbook é—œä¿‚

- **Inventory**ï¼šä¸»æ©Ÿæ¸…å–®

```ini
[helloworld] # ç¾¤çµ„åç¨±
localhost ansible_connection=local # ä¸»æ©Ÿåç¨± + é€£ç·šæ–¹å¼
```

![inventoryä¸»æ©Ÿ.png](image/ansible/inventoryä¸»æ©Ÿ.png "inventoryä¸»æ©Ÿ.png")

- **Playbook**ï¼šå‘Šè¨´ Ansible"è¦å°å“ªäº›ä¸»æ©Ÿåšä»€éº¼äº‹"

```yaml
- name: åŸ·è¡ŒHello worldåˆ—å°çš„ansible  # Play åç¨±
  hosts: helloworld            # æ“ä½œçš„ä¸»æ©Ÿç¾¤çµ„
  gather_facts: no             # ä¸æ”¶é›†ç³»çµ±è³‡è¨Š

  tasks:
    - name: é€™æ˜¯ç¬¬ä¸€å€‹taskä»»å‹™  # Task åç¨±
      debug:
        msg: "Hello world"          # Module debug é¡¯ç¤ºè¨Šæ¯
```
![playbookå…§å®¹èˆ‡å¯¦éš›åŸ·è¡Œ.png](image/ansible/playbookå…§å®¹èˆ‡å¯¦éš›åŸ·è¡Œ.png "playbookå…§å®¹èˆ‡å¯¦éš›åŸ·è¡Œ.png")
> æ³¨æ„ï¼š
> - Playbook åç¨±å¯è‡ªè¨‚ï¼Œä½†åŸ·è¡Œæ™‚è¦æŒ‡å®šæ­£ç¢ºè·¯å¾‘
> - å¦‚æœ `hosts:` æŒ‡å‘ä¸å­˜åœ¨çš„ç¾¤çµ„ï¼Œæœƒå‡ºç¾ `skipping: no hosts matched`

---

## å¦‚ä½•ä½¿ç”¨ Ansible

1. **å»ºç«‹ Ansible é…ç½®æª”æ¡ˆ** `ansible.cfg`ï¼ˆé€™æ˜¯ç‚ºäº†å¯ä»¥ç›´æ¥ä½¿ç”¨ `ansible-playbook {playbook}`ï¼‰

```ini
[defaults]
inventory = ./inventory.ini
```

2. **å»ºç«‹ Inventory æ¸…å–®** `inventory.ini`

```ini
[helloworld]
localhost ansible_connection=local
```

3. **åŸ·è¡Œ Playbook**

```bash
# æŒ‡å®š Inventory
ansible-playbook -i inventory.ini playbook.yml

# ä½¿ç”¨ ansible.cfg çš„é è¨­ inventory
ansible-playbook playbook.yml
```

---

## å»ºç«‹ Role
# Ansible Role ä»‹ç´¹


åœ¨ Ansible è£¡ï¼Œ**Role** æ˜¯ä¸€å€‹ã€Œæ¨¡çµ„åŒ–ã€å¯é‡è¤‡ä½¿ç”¨çš„ä»»å‹™å–®å…ƒã€ï¼Œå®ƒæŠŠç›¸é—œçš„ä»»å‹™ã€è®Šæ•¸ã€æ¨¡æ¿ã€éœæ…‹æª”æ¡ˆã€Handler ç­‰éƒ½æ•´ç†åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿ä½ åœ¨ä¸åŒ Playbook æˆ–å°ˆæ¡ˆä¸­é‡è¤‡ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦æ¯æ¬¡éƒ½é‡å¯«æ•´å€‹æµç¨‹ã€‚


ç°¡å–®èªªï¼Œ**Role å°±åƒä¸€å€‹å°å‹ç¨‹å¼åº«æˆ–åŠŸèƒ½æ¨¡çµ„**ã€‚
```bash
ansible-galaxy init roles/æª”å
```
![å¦‚ä½•å‰µå»ºgalaxy.png](image/ansible/å¦‚ä½•å‰µå»ºgalaxy.png "å¦‚ä½•å‰µå»ºgalaxy.png")

ç”Ÿæˆçš„ Role çµæ§‹å¦‚ä¸‹ï¼š

```
roles/
â””â”€â”€ æª”å/
â”œâ”€â”€ README.md # Role èªªæ˜æ–‡ä»¶
â”œâ”€â”€ defaults/
â”‚ â””â”€â”€ main.yml # é è¨­è®Šæ•¸ï¼ˆä½å„ªå…ˆç´šï¼‰
â”œâ”€â”€ files/ # éœæ…‹æª”æ¡ˆï¼Œä¾‹å¦‚è¨­å®šæª”ã€å®‰è£åŒ…
â”œâ”€â”€ handlers/
â”‚ â””â”€â”€ main.yml # é€šçŸ¥ Handlerï¼Œä¾‹å¦‚é‡å•Ÿæœå‹™
â”œâ”€â”€ meta/
â”‚ â””â”€â”€ main.yml # Role å…ƒè³‡æ–™ï¼Œä¾‹å¦‚ä¾è³´å…¶ä»– Role
â”œâ”€â”€ tasks/
â”‚ â””â”€â”€ main.yml # ä¸»è¦ä»»å‹™æµç¨‹
â”œâ”€â”€ templates/ # Jinja2 æ¨¡æ¿æª”æ¡ˆ
â””â”€â”€ vars/
â””â”€â”€ main.yml # é«˜å„ªå…ˆç´šè®Šæ•¸
```
# Ansible å¯¦å‹™éŒ¯èª¤ï¼šç›®éŒ„å‘½åéŒ¯èª¤

## éŒ¯èª¤ç¾è±¡

åŸ·è¡Œ `ansible-playbook` æ™‚å‡ºç¾ä»¥ä¸‹éŒ¯èª¤ï¼š
```bash
ERROR! the role 'hello' was not found in /path/to/roles/...
```
[![rolesç›®éŒ„å‘½åéŒ¯èª¤](image/ansible/rolesç›®éŒ„.png)](image/ansible/rolesç›®éŒ„.png)

